<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BoxGPT Pro</title>

<style>
:root {
  --bg:#0f0f0f; --panel:#1c1c1c; --text:#eee;
  --user:#2563eb; --bot:#2a2a2a;
}
.light {
  --bg:#f5f5f5; --panel:#fff; --text:#111;
  --user:#2563eb; --bot:#e5e5e5;
}
*{box-sizing:border-box}
body{
  margin:0;height:100vh;display:flex;
  background:var(--bg);color:var(--text);
  font-family:system-ui,sans-serif;
}
aside{
  width:260px;background:var(--panel);
  padding:12px;overflow-y:auto;
}
aside h2{margin:0 0 10px}
.chat-item{
  padding:8px;border-radius:8px;
  cursor:pointer;font-size:14px;
}
.chat-item:hover{background:#333}
.active{background:#444}
main{flex:1;display:flex;flex-direction:column}
header{
  padding:12px;background:var(--panel);
  display:flex;justify-content:space-between;
}
#chat{flex:1;overflow-y:auto;padding:15px}
.msg{
  max-width:80%;padding:10px 12px;
  border-radius:12px;margin-bottom:10px;
  white-space:pre-wrap;
}
.user{background:var(--user);margin-left:auto}
.bot{background:var(--bot)}
footer{
  display:flex;gap:10px;
  padding:12px;background:var(--panel)
}
input{flex:1;padding:10px;border-radius:8px;border:0}
button{padding:10px;border-radius:8px;border:0;cursor:pointer}
@media(max-width:700px){ aside{display:none} }
</style>
</head>

<body>

<aside>
  <h2>BoxGPT</h2>
  <button onclick="newChat()">‚ûï New Chat</button>
  <hr>
  <div id="chatList"></div>
</aside>

<main>
<header>
  <div id="title">Chat</div>
  <div>
    <button onclick="toggleTheme()">üåà</button>
    <button onclick="exportChat()">üíæ</button>
  </div>
</header>

<div id="chat"></div>

<footer>
  <input id="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."
    onkeydown="if(event.key==='Enter')send()">
  <button onclick="send()">‡∏™‡πà‡∏á</button>
</footer>
</main>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://api.groq.com/openai/v1/chat/completions";
const MODEL   = "openai/gpt-oss-120b";

/* ===== API KEY ===== */
const GROQ_KEY = "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";
}

/* ===== STATE ===== */
let db, chats={}, current=null;
const chatDiv=document.getElementById("chat");

/* ===== DB ===== */
const req=indexedDB.open("boxgpt",1);
req.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("chats",{keyPath:"id"});
};
req.onsuccess=e=>{
  db=e.target.result;
  loadChats();
};

/* ===== THEME ===== */
document.body.className=localStorage.theme||"";
function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.theme=document.body.className;
}

/* ===== CHAT MGMT ===== */
function newChat(){
  current=crypto.randomUUID();
  chats[current]={
    id:current,
    title:"New Chat",
    messages:[
      {role:"system",content:"‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢"}
    ]
  };
  saveChat(current);
  renderChats(); renderChat();
}

function loadChats(){
  const tx=db.transaction("chats","readonly")
    .objectStore("chats").getAll();
  tx.onsuccess=()=>{
    tx.result.forEach(c=>chats[c.id]=c);
    current=Object.keys(chats)[0]||null;
    if(!current) newChat();
    renderChats(); renderChat();
  };
}

function saveChat(id){
  db.transaction("chats","readwrite")
    .objectStore("chats").put(chats[id]);
}

function renderChats(){
  const list=document.getElementById("chatList");
  list.innerHTML="";
  Object.values(chats).forEach(c=>{
    const d=document.createElement("div");
    d.className="chat-item"+(c.id===current?" active":"");
    d.textContent=c.title;
    d.onclick=()=>{current=c.id;renderChats();renderChat()};
    list.appendChild(d);
  });
}

function renderChat(){
  chatDiv.innerHTML="";
  chats[current].messages
    .filter(m=>m.role!=="system")
    .forEach(m=>addMsg(m.content,m.role==="user"?"user":"bot"));
}

/* ===== UI ===== */
function addMsg(text,cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.textContent=text;
  chatDiv.appendChild(d);
  chatDiv.scrollTop=chatDiv.scrollHeight;
  return d;
}

/* ===== SEND ===== */
async function send(){
  const input=document.getElementById("input");
  const text=input.value.trim();
  if(!text) return;
  input.value="";

  addMsg(text,"user");
  const chat=chats[current];
  chat.messages.push({role:"user",content:text});
  if(chat.messages.length===2) chat.title=text.slice(0,20);

  const bot=addMsg("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‚Ä¶","bot");

  try{
    const res=await fetch(API_URL,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+localStorage.groq_key
      },
      body:JSON.stringify({
        model:MODEL,
        messages:chat.messages,
        max_tokens:800
      })
    });

    const data=await res.json();
    const reply=data.choices?.[0]?.message?.content || "no reply";

    chat.messages.push({role:"assistant",content:reply});
    saveChat(current);

    bot.textContent="";
    let i=0;
    const t=setInterval(()=>{
      bot.textContent+=reply[i++];
      if(i>=reply.length) clearInterval(t);
    },15);

  }catch(e){
    bot.textContent="‚ùå error ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Groq ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
  }
}

/* ===== EXPORT ===== */
function exportChat(){
  const blob=new Blob(
    [JSON.stringify(chats[current],null,2)],
    {type:"application/json"}
  );
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="chat.json";
  a.click();
}
</script>

</body>
</html>
